<!doctype html>
<html lang="en">
<head>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <link rel="stylesheet" href="public/style.css">

    <script src="https://d3js.org/d3.v4.js" crossorigin="anonymous"></script>

    <link rel="apple-touch-icon" sizes="57x57" href="public/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="public/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="public/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="public/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="public/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="public/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="public/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="public/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="public/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="public/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="public/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="public/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="public/favicon/favicon-16x16.png">
    <link rel="manifest" href="public/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="public/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>TopoLines</title>

</head>
<body>
<div>
    <h1>TopoLines</h1>
</div>


<div class="page">

    <div class="sidebar">
        <form id="parameterForm">
            <div class="form-group">
                <label for="dataset">Data Set</label>
                <select class="form-control form-control-sm" id="dataset" name="dataset" onchange="changeDataset();">
                </select>
            </div>
            <div class="form-group">
                <label for="datafile">Data File</label>
                <select class="form-control form-control-sm" id="datafile" name="datafile" onchange="changeDatafile();">
                </select>
            </div>

            <div class="form-group">
                <label for="filter">Filter Type</label>
                <select class="form-control form-control-sm" id="filter" name="filter" onchange="changeFilter()">
                    <option value="median">Rank - Median</option>
                    <option value="min">Rank - Minimum</option>
                    <option value="max">Rank - Maximum</option>
                    <option value="gaussian">Convolutional - Gaussian</option>
                    <option value="mean">Convolutional - Mean</option>
                    <option value="savitzky_golay">Convolutional - Savitzky-Golay</option>
                    <option value="cutoff">Frequency - Cutoff</option>
                    <option value="butterworth">Frequency - Butterworth</option>
                    <option value="chebyshev">Frequency - Chebyshev</option>
                    <option value="subsample">Subsampling - Uniform</option>
                    <option value="rdp">Subsmapling - Ramer-Douglas</option>
                    <option value="tda">Subsampling - TDA</option>
                </select>
            </div>
            <div class="form-group">
                <label for="level">Filter Level</label>
                <input type="range" class="custom-range" min="0" max="1" step="0.01" value="0" id="level" name="level"
                       onchange="changeFilterLevel()">
            </div>

        </form>
        <code><pre id="object_details" name="object_details" style=" width: 300px; ">
			</pre>
        </code>
    </div>


    <div class="page-content" id="visualization">
        <div>
        <svg width="1000" height="250" style="border: none;" id="linechart"></svg>
        </div>
        <div>
            <span style="display: inline-block; width: 24%;">
                    <label class="checkmark-container">Rank - Median<input type="checkbox" id="metric_median" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_median"></span></label>
                    <label class="checkmark-container">Rank - Minimum<input type="checkbox" id="metric_min" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_min"></span></label>
                    <label class="checkmark-container">Rank - Maximum<input type="checkbox" id="metric_max" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_max"></span></label>
            </span>
            <span style="display: inline-block; width: 24%;">
                    <label class="checkmark-container">Convolutional - Gaussian<input type="checkbox" id="metric_gaussian" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_gaussian"></span></label>
                    <label class="checkmark-container">Convolutional - Mean<input type="checkbox" id="metric_mean" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_mean"></span></label>
                    <label class="checkmark-container">Convolutional - Savitzky-Golay<input type="checkbox" id="metric_savitzky_golay" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_savitzky_golay"></span></label>
            </span>
            <span style="display: inline-block; width: 24%;">
                    <label class="checkmark-container">Frequency - Cutoff<input type="checkbox" id="metric_cutoff" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_cutoff"></span></label>
                    <label class="checkmark-container">Frequency - Butterworth<input type="checkbox" id="metric_butterworth" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_butterworth"></span></label>
                    <label class="checkmark-container">Frequency - Chebyshev<input type="checkbox" id="metric_chebyshev" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_chebyshev"></span></label>
            </span>
            <span style="display: inline-block; width: 24%;">
                    <label class="checkmark-container">Subsampling - Uniform<input type="checkbox" id="metric_subsample" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_subsample"></span></label>
                    <label class="checkmark-container">Subsmapling - Ramer-Douglas<input type="checkbox" id="metric_rdp" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_rdp"></span></label>
                    <label class="checkmark-container">Subsampling - TDA<input type="checkbox" id="metric_tda" checked="checked" onchange="updateMetrics();"><span class="checkmark checkmark_tda"></span></label>
            </span>
        </div>
        <div>
        <svg width="350" height="200" style="border: none;" id="test_plot1"></svg>
        <svg width="350" height="200" style="border: none;" id="test_plot2"></svg>
        <svg width="350" height="200" style="border: none;" id="test_plot3"></svg>
        <svg width="350" height="200" style="border: none;" id="test_plot4"></svg>
        <svg width="350" height="200" style="border: none;" id="test_plot5"></svg>
        <svg width="350" height="200" style="border: none;" id="test_plot6"></svg>
        </div>
        <div>
            <svg width="250" height="150" style="border: none;" id="info_perf"></svg>
        </div>
        <div>
        <svg width="250" height="150" style="border: none;" id="stats_mean"></svg>
        <svg width="250" height="150" style="border: none;" id="stats_pstdev"></svg>
        <svg width="250" height="150" style="border: none;" id="stats_sstdev"></svg>
        <svg width="250" height="150" style="border: none;" id="stats_pvar"></svg>
        <svg width="250" height="150" style="border: none;" id="stats_svar"></svg>
        <svg width="250" height="150" style="border: none;" id="stats_snr"></svg>
        <svg width="250" height="150" style="border: none;" id="stats_min"></svg>
        <svg width="250" height="150" style="border: none;" id="stats_max"></svg>
        </div>
        <div>
        <svg width="250" height="150" style="border: none;" id="metric_cov"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_pcc"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_src"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_l1"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_l2"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_linf"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_dvol"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_ent"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_freq"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_snr"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_bott"></svg>
        <svg width="250" height="150" style="border: none;" id="metric_wass"></svg>
        </div>

    </div>
</div>


<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>
        var datasets = {};
        var filter_list = [ "median", "min", "max", "gaussian", "mean", "savitzky_golay",
                            "cutoff", "butterworth", "chebyshev", "subsample", "rdp", "tda" ]

        //var myColor = d3.scaleOrdinal().domain(filter_list).range(d3.schemeSet3);
        var myColor = d3.scaleOrdinal().domain(filter_list)
                        .range(["gold", "blue", "green", "CornflowerBlue", "DeepPink", "grey", "darkgreen",
                                "pink", "brown", "slateblue", "darkgrey", "orange"]);


		var lc_svg = d3.select("#linechart");
		var lc_svg_width  = +lc_svg.attr("width");
		var lc_svg_height = +lc_svg.attr("height");

		var lc_margin = {left: 10, right: 15, top: 10, bottom: 15},
			lc_width  = lc_svg_width  - lc_margin.left - lc_margin.right,
			lc_height = lc_svg_height - lc_margin.top  - lc_margin.bottom;

        function updateSP( doc_id, dinput, data_name ){
			$(doc_id).empty();

            var sp_svg = d3.select(doc_id);
            var sp_svg_width  = +sp_svg.attr("width");
            var sp_svg_height = +sp_svg.attr("height");

            var sp_margin = {left: 45, right: 15, top: 20, bottom: 15},
                sp_width  = sp_svg_width  - sp_margin.left - sp_margin.right,
                sp_height = sp_svg_height - sp_margin.top  - sp_margin.bottom;

            data = dinput.map( function(d){
                return [ d['info']['filter level'], d[data_name[0]][data_name[1]], d['info']['filter name'] ];
            });

            var sp_xExt = [ 0, d3.max( data, function(d){ return d[0]; } ) ];
            var sp_yTmp = d3.extent( data, function(d){ return d[1]; } );
            var sp_yExt = [ Math.min(0,sp_yTmp[0]), Math.max(0,sp_yTmp[1]) ];

            var xAxis = d3.scaleLinear().domain( sp_xExt ).range([ 0, sp_width ]);
            var yAxis = d3.scaleLinear().domain( sp_yExt ).range([ sp_height, 0]);

            if( (sp_yExt[1]-sp_yExt[0]) < 0.1 || (sp_yExt[1]-sp_yExt[0]) > 100 ){
                sp_svg.append("g")
                    .attr("transform", "translate(" + sp_margin.left + "," + sp_margin.top + ")")
                    .call(d3.axisLeft(yAxis).ticks(5).tickFormat(d3.format(".1e")))
             }
             else{
                sp_svg.append("g")
                    .attr("transform", "translate(" + sp_margin.left + "," + sp_margin.top + ")")
                    .call(d3.axisLeft(yAxis).ticks(5));
             }

            sp_svg.append('g')
                .attr("transform", "translate(" + sp_margin.left + "," + sp_margin.top + ")")
                .selectAll("dot")
                .data(data)
                .enter()
                .append("circle")
                  .attr("cx", function (d) { return xAxis(d[0]); } )
                  .attr("cy", function (d) { return yAxis(d[1]); } )
                  .attr("r", 2)
                  //.style("fill", function (d) { return myColor(d[2]); } );
                  .attr("class", function(d){ return d[2] + "_filter"; } )

            sp_svg.append('text')
                    .attr('x',sp_svg_width/2)
                    .attr('y', 13)
                    .attr('text-anchor','middle')
                    .text(data_name[0]+":"+data_name[1]);
        }


        function update_test_plot( doc_id, dinput, d0, d1 ){
			$(doc_id).empty();

            var sp_svg = d3.select(doc_id);
            var sp_svg_width  = +sp_svg.attr("width");
            var sp_svg_height = +sp_svg.attr("height");

            var sp_margin = {left: 45, right: 15, top: 20, bottom: 15},
                sp_width  = sp_svg_width  - sp_margin.left - sp_margin.right,
                sp_height = sp_svg_height - sp_margin.top  - sp_margin.bottom;

            data = dinput.map( function(d){
                return [ d[d0[0]][d0[1]], d[d1[0]][d1[1]], d['info']['filter name'] ];
            });

            var sp_xTmp = d3.extent( data, function(d){ return d[0]; } );
            var sp_xExt = [ Math.min(0,sp_xTmp[0]), Math.max(0,sp_xTmp[1]) ];
            var sp_yTmp = d3.extent( data, function(d){ return d[1]; } );
            var sp_yExt = [ Math.min(0,sp_yTmp[0]), Math.max(0,sp_yTmp[1]) ];

            var xAxis = d3.scaleLinear().domain( sp_xExt ).range([ 0, sp_width ]);
            var yAxis = d3.scaleLinear().domain( sp_yExt ).range([ sp_height, 0]);

            if( (sp_yExt[1]-sp_yExt[0]) < 0.1 || (sp_yExt[1]-sp_yExt[0]) > 100 ){
                sp_svg.append("g")
                    .attr("transform", "translate(" + sp_margin.left + "," + sp_margin.top + ")")
                    .call(d3.axisLeft(yAxis).ticks(5).tickFormat(d3.format(".1e")))
             }
             else{
                sp_svg.append("g")
                    .attr("transform", "translate(" + sp_margin.left + "," + sp_margin.top + ")")
                    .call(d3.axisLeft(yAxis).ticks(5));
             }

            sp_svg.append('g')
                .attr("transform", "translate(" + sp_margin.left + "," + sp_margin.top + ")")
                .selectAll("dot")
                .data(data)
                .enter()
                .append("circle")
                  .attr("cx", function (d) { return xAxis(d[0]); } )
                  .attr("cy", function (d) { return yAxis(d[1]); } )
                  .attr("r", 2)
                  .attr("class", function(d){ return d[2] + "_filter"; } )

            sp_svg.append('text')
                    .attr('x',sp_svg_width/2)
                    .attr('y', 13)
                    .attr('text-anchor','middle')
                    .text(d0[0]+":"+d0[1]+", " +d1[0]+":"+d1[1]);
        }

        var metrics_data = null;

        function updateMetrics(){
			var active_filters = filter_list.filter( function(f){
			    return document.getElementById("metric_"+f).checked;
			});
            console.log( active_filters );

            dinput = metrics_data.filter( function(d){
                return active_filters.includes(d['info']['filter name']);
            });

            updateSP( "#info_perf", dinput, ['info','processing time'] )

            updateSP( "#stats_mean", dinput, ['statistics','mean'] )
            updateSP( "#stats_pstdev", dinput, ['statistics','pop stdev'] )
            updateSP( "#stats_sstdev", dinput, ['statistics','sample stdev'] )
            updateSP( "#stats_pvar", dinput, ['statistics','pop variance'] )
            updateSP( "#stats_svar", dinput, ['statistics','sample variance'] )
            updateSP( "#stats_snr", dinput, ['statistics','snr'] )
            updateSP( "#stats_min", dinput, ['statistics','minimum'] )
            updateSP( "#stats_max", dinput, ['statistics','maximum'] )

            updateSP( "#metric_cov", dinput, ['metrics','covariance'] )
            updateSP( "#metric_pcc", dinput, ['metrics','pearson cc'] )
            updateSP( "#metric_src", dinput, ['metrics','spearman rc'] )
            updateSP( "#metric_l1", dinput, ['metrics','L1 norm'] )
            updateSP( "#metric_l2", dinput, ['metrics','L2 norm'] )
            updateSP( "#metric_linf", dinput, ['metrics','L_inf norm'] )
            updateSP( "#metric_dvol", dinput, ['metrics','delta volume'] )
            updateSP( "#metric_ent", dinput, ['metrics','approx entropy'] )
            updateSP( "#metric_freq", dinput, ['metrics','frequency preservation'] )
            updateSP( "#metric_snr", dinput, ['metrics','signal to noise'] )
            updateSP( "#metric_snr", dinput, ['metrics','signal to noise'] )
            updateSP( "#metric_bott", dinput, ['metrics','peak bottleneck'] )
            updateSP( "#metric_wass", dinput, ['metrics','peak wasserstein'] )

            update_test_plot( "#test_plot1", dinput, ['metrics','approx entropy'], ['metrics','L_inf norm'] )
            update_test_plot( "#test_plot2", dinput, ['metrics','approx entropy'], ['metrics','peak bottleneck'] )
            update_test_plot( "#test_plot3", dinput, ['metrics','approx entropy'], ['metrics','peak wasserstein'] )
            update_test_plot( "#test_plot4", dinput, ['metrics','approx entropy'], ['metrics','L1 norm'] )
            update_test_plot( "#test_plot5", dinput, ['metrics','L_inf norm'], ['metrics','peak wasserstein'] )
            update_test_plot( "#test_plot6", dinput, ['metrics','peak bottleneck'], ['metrics','peak wasserstein'] )
        }

        function reloadMetrics(){

            var url = "metric?"
                        + "dataset=" + document.getElementById("dataset").value
                        + "&datafile=" + document.getElementById("datafile").value
                        + "&filter=all" ;

            console.log(url);
            d3.json( url, function( dinput ) {
            //d3.json( "metric?" + $('#parameterForm').serialize(), function( dinput ) {
                console.log(dinput);

                metrics_data = dinput;

                updateMetrics();


            });
        }

		function reloadChart(){
			
			$("#linechart").empty();

			//console.log( "data?" + $('#parameterForm').serialize());
			d3.json( "data?" + $('#parameterForm').serialize(), function( dinput ) {

			    //console.log( dinput );

				orig_data = dinput['original'].map( function(d){
					return {'x':d[0],'y':d[1]};
				});

				filt_data = dinput['filtered'].map( function(d){
					return {'x':d[0],'y':d[1]};
				});

				document.getElementById("object_details").innerHTML = JSON.stringify({info:dinput['info'],stats:dinput['statistics'],metrics:dinput['metrics']}, undefined, 2);

				xExt = [0,orig_data.length-1];
                yExt = d3.extent( orig_data, function(d){ return d['y']; });
				
                var xAxis = d3.scaleLinear().domain( xExt ).range([ 0, lc_width ]);
                var yAxis = d3.scaleLinear().domain( yExt ).range([ lc_height, 0]);


				lc_svg.append("path")
                    .attr("transform", "translate(" + lc_margin.left + "," + lc_margin.top + ")")
					  .datum( orig_data )
					  .attr("fill", "none")
					  .attr("stroke", "lightgray")
					  .attr("stroke-width", 2)
					  .attr("d", d3.line()
						.x(function(d) { return xAxis(d['x']); })
						.y(function(d) { return yAxis(d['y']); })
						);

				lc_svg.append("path")
                    .attr("transform", "translate(" + lc_margin.left + "," + lc_margin.top + ")")
					  .datum( filt_data )
					  .attr("fill", "none")
					  .attr("stroke", "steelblue")
					  .attr("stroke-width", 2)
					  .attr("d", d3.line()
						.x(function(d) { return xAxis(d['x']); })
						.y(function(d) { return yAxis(d['y']); })
						);

				
			});
			
			
			
		}
		


        function changeDataset(){
            var e = document.getElementById("dataset");
            var dset = e.options[e.selectedIndex].value;
            datasets[dset].sort();
            html = "";
            datasets[dset].forEach( function(d){
		        html += '<option value="'+d+'">'+d+'</option>';
            });
            document.getElementById("datafile").innerHTML = html;
            reloadChart();
            reloadMetrics();
        }

        function changeDatafile(){
            reloadChart();
            reloadMetrics();
        }

        function changeFilter(){
            reloadChart();
            reloadMetrics();
        }

        function changeFilterLevel(){
            reloadChart();
        }


		d3.json( "datasets", function( dinput ) {
            datasets = dinput;

            html = "";
            keys = Object.keys(datasets);
            keys.sort();

		    keys.forEach( function(d){
		        html += '<option value="'+d+'">'+d+'</option>';
		    });

            document.getElementById("dataset").innerHTML = html;

            changeDataset();
		});




</script>


</body>
</html>

